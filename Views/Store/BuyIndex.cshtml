@using G_APIs.Models
@using G_APIs.Models.ComponentModels
@model OrderVM

@Html.Partial("_FormTitle", new FormTitle()
{
    Icon = Html.Raw("<svg viewBox=\"0 0 24 24\" width=\"42\" height=\"42\" class=\"main-grid-item-icon\" fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"1.50\">\r\n  <circle cx=\"9\" cy=\"21\" r=\"1\" />\r\n  <circle cx=\"20\" cy=\"21\" r=\"1\" />\r\n  <path d=\"M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6\"/>\r\n</svg>\r\n"),
    Title = "خرید طلا",
    Description = "صفحه خرید، مشاهده آنی قیمت طلا و مشاهده آنلاین اطلاعات کیف پول"
})

<div class="row gold-row">
    @using (Html.Box("باکس خرید", col: 6))
    {
        <div class="widget-content widget-content-area">
            <form form class="frmBuy" id="frmBuy" action="javascript:void(0);" novalidate>
                @Html.Action("GoldOnlinePrice", new { isBuy = true })
                <div class="col-auto">
                    <label for="Weight">وزن درخواستی (گرم)</label>
                    <div class="mb-3">
                        <input name="Weight" type="number" class="form-control text-right" value="@Model.Weight" aria-describedby="Weight-addon" required>
                        <div class="invalid-feedback">
                            وارد کردن این گزینه الزامیست
                        </div>
                    </div>
                </div>
                <div class="col-auto">
                    <label for="CurrentCalculatedPrice">کل مبلغ</label>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="CurrentCalculatedPrice-addon">ريال</span>
                        </div>
                        <input name="CurrentCalculatedPrice" type="text" class="form-control text-right" value="@Model.CurrentCalculatedPrice.ToString("N0")" aria-describedby="CurrentCalculatedPrice-addon">
                    </div>
                </div>
                <hr />
                <div class="transaction-result">
                    @Html.Partial("_GoldAlert", new GoldAlert
                    {
                        AlertContentTexts = new List<string> { "کاربر محترم، مبلغ کل از کیف پول کسر و به صورت وزن بر حسب گرم به کیف پول شما اضافه خواهد شد." },
                        AlertTitleIcon = "fa fa-bolt fa-xl",
                        AlertTitleText = "نکته",
                        AlertType = GoldAlertTypes.Warning,
                    })
                </div>
                <div class="col-auto field-wrapper command-panel">
                    @Html.Partial("_GoldButton", new GoldButton()
                    {
                        ButtonType = GoldButtonTypes.submit,
                        Name = "btnBuy",
                        Icon = "fa fa-shopping-basket fa-2x",
                        Class = "btn btn-success",
                        Text = "خرید",
                        OnClick = "performBuy()"
                    })
                    @Html.Partial("_GoldButton", new GoldButton()
                    {
                        ButtonType = GoldButtonTypes.cancel,
                        Name = "btnCancel"
                    })
                </div>
            </form>
        </div>
    }
    @using (Html.Box(col: 6))
    {
        @Html.Action("Wallet", "Fund", new { ShowButtons = false })
    }
</div>

<script>
    $(function () {
        disableBuy();
        $("input[name='@nameof(Model.CurrentCalculatedPrice)'],input[name='@nameof(Model.CurrentOnlinePrice)']").keydown(function (e) {
            e.stopPropagation();
            return false;
        });
    });
    function performBuy() {
        $('#frmBuy').ajaxForm({
            validation: true,
            url: '/Store/SubmitBuy',
            jwt: true,
            blockui: true,
            mixin: false,
            target:".transaction-result",
            success: function (data) {
                debugger;
                $("input[name='@nameof(Model.Weight)']").val('');
                disableBuy();
                //window.clearTimeout(dowhile);
                //dowhile = null;
            }
        });
    }
    function disableBuy() {
        $("#btnBuy").attr("disabled", "disabled");
        $("input[name='@nameof(Model.CurrentCalculatedPrice)']").val('');
    }
    $("input[name='@nameof(Model.Weight)']").bind('change', function (e) {
        var inpCurrentCalculatedPrice = $("input[name='@nameof(Model.CurrentCalculatedPrice)']");
        var value = $(this).val();
        if (value > 0) {
            $.ajax({
                type: 'POST',
                url: '/Store/GetOnlinePrice',
                data: {
                    weight: value
                },
                success: function (data) {
                    if ($.isNumeric(data)) {
                        if (data > 0) {
                            $("#btnBuy").removeAttr("disabled", "disabled");
                            var formattedData = Number(data).toLocaleString('en');
                            inpCurrentCalculatedPrice.val(formattedData);
                            inpCurrentCalculatedPrice.css("background-color", "#25b61738");
                            setTimeout(function () {
                                inpCurrentCalculatedPrice.css("background-color", "");
                            }, 1000);
                        }
                    } else {
                        window.location = "/Account/Login";
                    }
                },
                error: function (data) {
                    console.log(data)
                }
            });
        } else {
            disableBuy();
        }
    });







    timer.pause();
    // Do some stuff...
    timer.resume();
</script>
